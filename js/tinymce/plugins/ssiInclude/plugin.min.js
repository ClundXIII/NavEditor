(function() {
	tinymce.PluginManager.add('ssiInclude', function(editor, url) {
		
		var placeholder = '<div class="ssi-include-placeholder-container" style="border: solid 1px #ccc;display: inline-block;width: 300px;text-align: center;padding: 10px;border-radius: 4px;"><h3>SSI Include</h3><div class="ssi-instruction"></div></div>',
			$placeholder = $(placeholder);

		editor.on('BeforeSetContent', function(evt) {
			
			if (evt.initial) return;
			
			var content = evt.content,
				$content = $(content),
				occurences = content.match(/<!--#/g);

			if(occurences) {
				for (var i = 0; i < occurences.length; i++) {

					var index_start = content.search(/<!--#/),
						index_end = index_start + content.substring(index_start, content.length-1).search(/-->/),
						instruction = content.substring(index_start+5, index_end);

					$placeholder.find(".ssi-instruction").html(instruction);
					content = content.replace("<!--#" + instruction + "-->", $placeholder.clone().wrap('<p>').parent().html());
				};

				evt.content  = content;
			}
			
		});


		editor.on('PostProcess', function(evt) {
			var content = evt.content,
				$content = $("<div>" + content + "<div>");

			$content.find(".ssi-include-placeholder-container").each( function(elem) {
				var $elem = $(this),
					ssi = $elem.find(".ssi-instruction").text();

				$elem.replaceWith("<!--#" + ssi + "-->");
			});

			evt.content = $content.html();
		});

	});
})();