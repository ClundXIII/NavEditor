(function() {
	tinymce.PluginManager.add('ssiInclude', function(editor, url) {
		
		var placeholder = '<div class="ssi-include-placeholder-container" style="position: relative; border: solid 1px #ccc;display: inline-block;width: 300px;text-align: center;padding: 10px;border-radius: 4px;"><a href="javascript:void(0);" class="ssi-close" style="position: absolute;top: 0px;right: 0px;color: black;text-decoration: none;border-bottom-left-radius: 3px;border-bottom: solid 1px #ddd;border-left: solid 1px #ddd; background: #fafafa;padding: 1px 3px;">L&ouml;schen</a><h3>SSI Include</h3><div class="ssi-instruction"></div></div>',
			$placeholder = $(placeholder);

		editor.on('BeforeSetContent', function(evt) {
			
			if (evt.initial) return;

			if (evt.content == undefined) return;
			
			var content = evt.content,
				$content = $(content),
				occurences = content.match(/<!--#/g);

			if(occurences) {
				for (var i = 0; i < occurences.length; i++) {

					var index_start = content.search(/<!--#/),
						index_end = index_start + content.substring(index_start, content.length-1).search(/-->/),
						instruction = content.substring(index_start+5, index_end);

					$placeholder.attr("data-id", i).find(".ssi-instruction").html(instruction);
					content = content.replace("<!--#" + instruction + "-->", $placeholder.clone().wrap('<p>').parent().html());
				};

				evt.content  = content;
			}
			
		});

		editor.on('click', function(e) {
           	
       	 	
			var $target = $(e.target);

			if($target.hasClass("ssi-close"))
				editor.dom.remove($target.parent()[0]);
            
        });


		editor.on('PostProcess', function(evt) {
			var content = evt.content,
				$content = $("<div>" + content + "<div>");

			$content.find(".ssi-include-placeholder-container").each( function(elem) {
				var $elem = $(this),
					ssi = $elem.find(".ssi-instruction").text();

				$elem.replaceWith("<!--#" + ssi + "-->");
			});

			evt.content = $content.html();
		});

	});
})();